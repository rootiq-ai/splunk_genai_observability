<form version="1.1" theme="dark">
  <label>RAG Analytics</label>
  <description>Analyze RAG pipeline performance - retrieval quality, latency breakdown, and end-to-end metrics</description>
  <!-- RAG KPIs -->
  <!-- Latency Breakdown -->
  <!-- Retrieval Quality -->
  <!-- Vector Store Performance -->
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_range" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="vector_store_filter" searchWhenChanged="true">
      <label>Vector Store</label>
      <choice value="*">All</choice>
      <default>*</default>
      <search>
        <query>`genai_retrieval_spans` | stats count by vector_store | sort - count</query>
        <earliest>-7d</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>vector_store</fieldForLabel>
      <fieldForValue>vector_store</fieldForValue>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>RAG Requests</title>
      <single>
        <search>
          <query>`genai_chain_spans` | stats count</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x006d9c"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Avg Retrieval Time</title>
      <single>
        <search>
          <query>`genai_retrieval_spans` vector_store=$vector_store_filter$ | stats avg(duration_ms) as avg | eval avg = round(avg, 0)</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="colorMode">block</option>
        <option name="unit">ms</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[500,2000]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Avg Docs Retrieved</title>
      <single>
        <search>
          <query>`genai_retrieval_spans` vector_store=$vector_store_filter$ | stats avg(documents_retrieved) as avg | eval avg = round(avg, 1)</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x006d9c"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Avg Relevance Score</title>
      <single>
        <search>
          <query>`genai_retrieval_spans` vector_store=$vector_store_filter$ | stats avg(relevance_score) as avg | eval avg = round(avg * 100, 1)</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="colorMode">block</option>
        <option name="unit">%</option>
        <option name="rangeColors">["0xdc4e41","0xf8be34","0x53a051"]</option>
        <option name="rangeValues">[60,80]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>End-to-End Latency</title>
      <single>
        <search>
          <query>`genai_chain_spans` | stats avg(duration_ms) as avg | eval avg = round(avg, 0)</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="colorMode">block</option>
        <option name="unit">ms</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[3000,8000]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>RAG Latency Breakdown (Retrieval vs Generation)</title>
      <chart>
        <search>
          <query>`genai_traces_index` vector_store=$vector_store_filter$ (span_type="RETRIEVER" OR span_type="LLM" OR span_type="EMBEDDING")
| stats avg(eval(if(span_type="RETRIEVER", duration_ms, null()))) as "Retrieval", 
       avg(eval(if(span_type="EMBEDDING", duration_ms, null()))) as "Embedding",
       avg(eval(if(span_type="LLM", duration_ms, null()))) as "Generation"| transpose
| rename "row 1" as Value, "column" as Type</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Latency Components Over Time</title>
      <chart>
        <search>
          <query>`genai_traces_index` vector_store=$vector_store_filter$ (span_type="RETRIEVER" OR span_type="LLM")
| timechart span=1h avg(eval(if(span_type="RETRIEVER", duration_ms, null()))) as "Retrieval", avg(eval(if(span_type="LLM", duration_ms, null()))) as "Generation"</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.text">Latency (ms)</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Retrieval Quality Over Time</title>
      <chart>
        <search>
          <query>`genai_retrieval_spans` vector_store=$vector_store_filter$ 
| timechart span=1h avg(relevance_score) as "Relevance Score", avg(documents_retrieved) as "Docs Retrieved"</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.chart.overlayFields">"Docs Retrieved"</option>
      </chart>
    </panel>
    <panel>
      <title>Documents Retrieved Distribution</title>
      <chart>
        <search>
          <query>`genai_retrieval_spans` vector_store=$vector_store_filter$ 
| stats count by documents_retrieved | sort documents_retrieved</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisTitleX.text">Documents Retrieved</option>
        <option name="charting.legend.placement">none</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Vector Store Performance Comparison</title>
      <table>
        <search>
          <query>`genai_retrieval_spans` vector_store=$vector_store_filter$ 
| stats count as queries, 
       avg(duration_ms) as avg_latency,
       perc95(duration_ms) as p95_latency,
       avg(documents_retrieved) as avg_docs,
       avg(relevance_score) as avg_relevance,
       sum(is_error) as errors
       by vector_store, embedding_model
| eval error_rate = round((errors/queries)*100, 2)
| eval avg_latency = round(avg_latency, 0)
| eval p95_latency = round(p95_latency, 0)
| eval avg_docs = round(avg_docs, 1)
| eval avg_relevance = round(avg_relevance * 100, 1)
| sort - queries
| table vector_store, embedding_model, queries, avg_latency, p95_latency, avg_docs, avg_relevance, error_rate
| rename vector_store as "Vector Store", embedding_model as "Embedding Model", queries as "Queries", avg_latency as "Avg Latency (ms)", p95_latency as "P95 (ms)", avg_docs as "Avg Docs", avg_relevance as "Relevance %", error_rate as "Error %"</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
        <format type="color" field="Relevance %">
          <colorPalette type="list">[#DC4E41,#F8BE34,#53A051]</colorPalette>
          <scale type="threshold">60,80</scale>
        </format>
      </table>
    </panel>
  </row>
</form>