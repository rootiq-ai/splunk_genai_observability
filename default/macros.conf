# =============================================================================
# Search Macros for GenAI Observability Platform
# =============================================================================

# -----------------------------------------------------------------------------
# Index Macros
# -----------------------------------------------------------------------------

[genai_traces_index]
definition = index=genai_traces
iseval = 0

# -----------------------------------------------------------------------------
# Span Type Filters
# -----------------------------------------------------------------------------

[genai_llm_spans]
definition = `genai_traces_index` span_type="LLM"
iseval = 0

[genai_retrieval_spans]
definition = `genai_traces_index` span_type="RETRIEVER"
iseval = 0

[genai_embedding_spans]
definition = `genai_traces_index` span_type="EMBEDDING"
iseval = 0

[genai_agent_spans]
definition = `genai_traces_index` span_type="AGENT"
iseval = 0

[genai_tool_spans]
definition = `genai_traces_index` span_type="TOOL"
iseval = 0

[genai_chain_spans]
definition = `genai_traces_index` span_type="CHAIN"
iseval = 0

[genai_evaluation_spans]
definition = `genai_evals_index` span_type="EVALUATION"
iseval = 0

# -----------------------------------------------------------------------------
# Cost Macros
# -----------------------------------------------------------------------------

[genai_cost_lookup]
definition = lookup genai_model_pricing model_name OUTPUT input_price_per_1k output_price_per_1k
iseval = 0

[genai_calculate_cost]
definition = eval estimated_cost = round(((input_tokens/1000) * input_price_per_1k) + ((output_tokens/1000) * output_price_per_1k), 6)
iseval = 0

[genai_cost_stats]
definition = `genai_cost_lookup` | `genai_calculate_cost` | stats sum(estimated_cost) as total_cost, avg(estimated_cost) as avg_cost_per_request, sum(input_tokens) as total_input_tokens, sum(output_tokens) as total_output_tokens
iseval = 0

[genai_cost_stats_by(1)]
definition = `genai_cost_lookup` | `genai_calculate_cost` | stats sum(estimated_cost) as total_cost, avg(estimated_cost) as avg_cost_per_request, count as requests by $field$
iseval = 0
args = field

[genai_daily_cost]
definition = `genai_cost_lookup` | `genai_calculate_cost` | timechart span=1d sum(estimated_cost) as daily_cost
iseval = 0

[genai_cost_by_model]
definition = `genai_cost_lookup` | `genai_calculate_cost` | stats sum(estimated_cost) as total_cost, count as requests by model_name | sort - total_cost
iseval = 0

# -----------------------------------------------------------------------------

[genai_throughput]
definition = timechart span=1m count as requests_per_minute
iseval = 0

[genai_throughput_by(1)]
definition = timechart span=1m count as requests_per_minute by $field$
iseval = 0
args = field

[genai_tokens_per_second]
definition = eval tokens_per_second = if(duration_ms > 0, round(output_tokens / (duration_ms / 1000), 2), 0)
iseval = 0

[genai_slow_requests(1)]
definition = where duration_ms > $threshold$
iseval = 0
args = threshold

[genai_model_comparison]
definition = `genai_llm_spans` | `genai_latency_stats_by(model_name)` | `genai_cost_lookup` | `genai_calculate_cost`
iseval = 0

# -----------------------------------------------------------------------------
# Trace Analysis Macros
# -----------------------------------------------------------------------------

[genai_trace_timeline(1)]
definition = `genai_traces_index` trace_id="$trace_id$" | sort span_id | table _time, span_id, parent_span_id, span_type, name, duration_ms, status
iseval = 0
args = trace_id

[genai_trace_tree(1)]
definition = `genai_traces_index` trace_id="$trace_id$" | eval depth=0 | sort span_id
iseval = 0
args = trace_id

[genai_trace_cost(1)]
definition = `genai_traces_index` trace_id="$trace_id$" span_type="LLM" | `genai_cost_lookup` | `genai_calculate_cost` | stats sum(estimated_cost) as trace_total_cost
iseval = 0
args = trace_id

[genai_trace_duration(1)]
definition = `genai_traces_index` trace_id="$trace_id$" | stats max(eval(_time + (duration_ms/1000))) as end_time, min(_time) as start_time | eval total_duration_ms = round((end_time - start_time) * 1000, 2)
iseval = 0
args = trace_id

# -----------------------------------------------------------------------------
# RAG Analysis Macros
# -----------------------------------------------------------------------------

[genai_rag_pipeline]
definition = `genai_traces_index` (span_type="RETRIEVER" OR span_type="LLM") | transaction trace_id maxspan=5m | where eventcount > 1
iseval = 0

[genai_retrieval_quality]
definition = `genai_retrieval_spans` | stats avg(relevance_score) as avg_relevance, avg(documents_retrieved) as avg_docs, avg(duration_ms) as avg_latency by vector_store
iseval = 0

[genai_rag_latency_breakdown]
definition = `genai_traces_index` | stats sum(eval(if(span_type="RETRIEVER", duration_ms, 0))) as retrieval_time, sum(eval(if(span_type="LLM", duration_ms, 0))) as generation_time by trace_id
iseval = 0


[genai_error_rate]
definition = stats count as total_requests, sum(is_error) as error_count | eval error_rate = round((error_count/total_requests)*100, 2)
iseval = 0


